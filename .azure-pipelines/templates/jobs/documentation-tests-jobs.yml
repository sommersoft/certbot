jobs:
  - job: doc_test
    pool:
      vmImage: ubuntu-latest

    steps:
      - bash: |
          FINAL_STATUS=0
          declare -a FAILED_BUILDS
          python3 -m venv .venv
          source .venv/bin/activate
          python tools/pipstrap.py
          for x in */docs
          do
            echo ""
            echo "##[group]Building $x"
            pip install -q -e $x/..[docs]
            if ! sphinx-build -EW --keep-going -b html $x $x/_build/html; then
              FINAL_STATUS=1;
              FAILED_BUILDS[${#FAILED_BUILDS[@]}]="${x%/docs}"
            fi
            echo "final: $FINAL_STATUS"
            echo "##[endgroup]"

          done
          echo "final: $FINAL_STATUS"
          echo "failed: ${FAILED_BUILDS[*]}"
          if [ $FINAL_STATUS != 0 ]; then
            echo "##[error]The following builds failed: ${FAILED_BUILDS[*]}";
          fi
        displayName: Build Sphinx Documentation
